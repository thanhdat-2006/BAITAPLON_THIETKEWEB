<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lịch Sử Đặt Tour - Viettravel</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header>
        <div class="container">
            <a href="index.html" class="logo">
                 <img src="assets/images/logoweb.png" alt="Viettravel Logo" class="logo-img">
            </a>
            <button id="nav-toggle" class="nav-toggle" aria-label="Mở menu" aria-expanded="false">
                <span class="hamburger"></span>
            </button>
            <nav>
                <ul class="nav-links">
                    <li><a href="index.html">Trang chủ</a></li>
                    <li><a href="destinations.html">Điểm đến</a></li>
                    <li><a href="tours.html">Tours</a></li>
                    <li><a href="hotels.html">Dịch vụ</a></li>
                    <li><a href="booking-history.html" class="active">Lịch sử</a></li>
                    <li><a href="evaluations.html">Đánh giá</a></li>
                    <li><a href="contact.html" class="btn-contact">Liên hệ</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <section class="page-banner">
        <div class="banner-content"><h2>Lịch Sử Đặt Tour</h2></div>
    </section>

    <section class="section-padding container">
        <!-- empty state -->
        <div id="empty-history" style="text-align:center;padding:40px 0;display:none;">
          <p>Bạn chưa đặt tour nào cả.</p>
          <a class="btn-primary" href="tours.html">Đặt tour ngay</a>
        </div>

        <!-- section chứa bảng lịch sử (mặc định ẩn, sẽ hiện khi có booking) -->
        <div id="bookings-section" style="display:none;">
          <div class="table-responsive">
              <table class="history-table">
                  <thead>
                      <tr>
                          <th class="col-id">Mã tour</th>
                          <th class="col-name">Tên Tour</th>
                          <th class="col-date">Ngày đi</th>
                          <th class="col-people">Số khách</th>
                          <th class="col-status">Trạng thái</th>
                          <th class="col-action">Hành động</th>
                      </tr>
                  </thead>
                  <tbody id="history-list"></tbody>
              </table>
          </div>

          <div class="history-actions">
            <button id="clear-history-btn" class="btn-clear-all">
        <i class="fas fa-trash-alt"></i> Xóa toàn bộ lịch sử
    </button>
</div>
    </section>

    <footer>
        <div class="container footer-content">
            <div class="footer-col">
                <div class="footer-logo">
                    <img src="assets/images/logoweb.png" alt="Viettravel Logo">
                </div>
                <p>Thổi bùng đam mê du lịch và khám phá.</p>
                <div id="footer-datetime" class="footer-datetime" aria-live="polite"></div>
            </div>

            <div class="footer-col">
                <h4>Liên kết</h4>
                <ul>
                    <li><a href="index.html">Trang chủ</a></li>
                    <li><a href="destinations.html">Điểm đến</a></li>
                    <li><a href="tours.html">Tours</a></li>
                    <li><a href="hotels.html">Dịch vụ</a></li>
                    <li><a href="booking-history.html">Lịch sử</a></li>
                    <li><a href="evaluations.html">Đánh giá</a></li>
                    <li><a href="contact.html">Liên hệ</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>Đối tác hợp tác</h4>
                <div class="partners-list" aria-label="Đối tác hợp tác">
                    <div class="partner-item">
                        <a href="https://www.traveloka.com/vi-vn" target="_blank" rel="noopener noreferrer">
                            <img src="assets/images/partners/partner_1.jpg" alt="Đối tác 1">
                        </a>
                    </div>
                    <div class="partner-item">
                        <a href="https://www.flightcentre.com.au/" target="_blank" rel="noopener noreferrer">
                            <img src="assets/images/partners/partner_2.jpg" alt="Đối tác 2">
                        </a>
                    </div>
                    <div class="partner-item">
                        <a href="https://www.ivivu.com/" target="_blank" rel="noopener noreferrer">
                            <img src="assets/images/partners/partner_3.jpg" alt="Đối tác 3">
                        </a>
                    </div>
                    <div class="partner-item">
                        <a href="https://www.americanexpress.com/" target="_blank" rel="noopener noreferrer">
                            <img src="assets/images/partners/partner_4.jpg" alt="Đối tác 4">
                        </a>
                    </div>
                </div>
            </div>

            <div class="footer-col">
                <h4>Phương thức thanh toán</h4>
                <div class="payments-list" aria-label="Đối tác thanh toán">
                    <a href="https://www.visa.com" target="_blank" rel="noopener noreferrer" class="payment-item">
                        <img src="assets/images/payments/payment_1.png" alt="Visa">
                    </a>
                    <a href="https://www.mastercard.com" target="_blank" rel="noopener noreferrer" class="payment-item">
                        <img src="assets/images/payments/payment_2.png" alt="Mastercard">
                    </a>
                    <a href="https://www.vn.jcb/vi/index.html" target="_blank" rel="noopener noreferrer" class="payment-item">
                        <img src="assets/images/payments/payment_3.png" alt="JCB">
                    </a>
                    <a href="https://www.momo.vn/" target="_blank" rel="noopener noreferrer" class="payment-item">
                        <img src="assets/images/payments/payment_4.png" alt="Momo">
                    </a>
                </div>
            </div>
        </div>
        <div class="copyright">
            <p>&copy; 2025 Viettravel. All rights reserved.|Support 24/24</p>
        </div>
    </footer>

    <script src="assets/js/main.js"></script>

    <script>
    (function () {
        const KEY = 'bookings';
        const tbody = document.getElementById('history-list');
        const emptyEl = document.getElementById('empty-history');
        const bookingsSection = document.getElementById('bookings-section');
        const clearBtn = document.getElementById('clear-history-btn');
        // --- FIX NAV TOGGLE (hamburger menu) ---
        const navToggle = document.getElementById('nav-toggle');
        const navLinks = document.querySelector('.nav-links');
        if (navToggle && navLinks) {
            navToggle.addEventListener('click', function () {
                const expanded = navToggle.getAttribute('aria-expanded') === 'true';
                navToggle.setAttribute('aria-expanded', !expanded);
                navLinks.classList.toggle('show');
            });
            // Close menu when clicking a nav link
            navLinks.querySelectorAll('a').forEach(function (a) {
                a.addEventListener('click', function () {
                    navLinks.classList.remove('show');
                    navToggle.setAttribute('aria-expanded', 'false');
                });
            });
            // Click outside nav closes it
            document.addEventListener('click', function (e) {
                if (!navLinks.contains(e.target) && e.target !== navToggle) {
                    navLinks.classList.remove('show');
                    navToggle.setAttribute('aria-expanded', 'false');
                }
            });
        }

        function loadBookings() {
            let raw = localStorage.getItem(KEY) || '[]';
            let arr;
            try { arr = JSON.parse(raw) || []; } catch (e) { arr = []; }

            // lọc booking hợp lệ - chấp nhận tourName hoặc tour
            const isValid = b => {
                if (!b) return false;
                const name = (b.tourName || b.tour || '').toString().trim();
                return name && name.toLowerCase() !== 'undefined';
            };
            const cleaned = arr.filter(isValid);

            // lưu nếu có thay đổi
            if (cleaned.length !== arr.length) {
                localStorage.setItem(KEY, JSON.stringify(cleaned));
            }
            return cleaned;
        }

        function formatDate(dateStr) {
            if (!dateStr) return '';
            const m1 = dateStr.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (m1) return `${m1[3]}-${m1[2]}-${m1[1]}`;
            const d = new Date(dateStr);
            if (!isNaN(d)) {
                const dd = String(d.getDate()).padStart(2,'0');
                const mm = String(d.getMonth()+1).padStart(2,'0');
                const yy = d.getFullYear();
                return `${dd}-${mm}-${yy}`;
            }
            return dateStr;
        }

        function render() {
            const bookings = loadBookings();
            tbody.innerHTML = '';

            // toggle hiển thị section/empty
            if (!bookings.length) {
                bookingsSection.style.display = 'none';
                emptyEl.style.display = 'block';
                return;
            } else {
                bookingsSection.style.display = 'block';
                emptyEl.style.display = 'none';
            }

            // đọc danh sách đánh giá để biết booking nào đã được đánh giá
            const evaluations = JSON.parse(localStorage.getItem('evaluations') || '[]');
            const evaluatedIds = new Set(
                evaluations.map(e => String(e.bookingId || e.order || '').replace(/^#+/, '').trim()).filter(Boolean)
            );

            bookings.forEach(b => {
                const tr = document.createElement('tr');

                const idTd = document.createElement('td');
                idTd.textContent = b.id || ('#' + (b.bookingId || '').toString());
                tr.appendChild(idTd);

                const nameTd = document.createElement('td');
                let nameOnly = (b.tourName || b.tour || '').toString();
                const priceIdx = nameOnly.indexOf('Giá:');
                if (priceIdx !== -1) nameOnly = nameOnly.slice(0, priceIdx);
                nameOnly = nameOnly.replace(/[\s\-–—]+$/g, '').trim();
                nameTd.textContent = nameOnly;
                tr.appendChild(nameTd);

                const dateTd = document.createElement('td');
                dateTd.textContent = formatDate(b.startDate || b.bookingDate || b.date || '');
                tr.appendChild(dateTd);

                const peopleTd = document.createElement('td');
                peopleTd.textContent = (b.people ? b.people + (String(b.people).includes('khách') ? '' : ' khách') : '');
                tr.appendChild(peopleTd);

                const statusTd = document.createElement('td');
                const span = document.createElement('span');
                span.className = 'status-badge status-confirmed';
                // Nếu status là "Chờ..." (hoặc rỗng), hiển thị "Đã xác nhận"
                let statusText = (b.status || '').toString().trim();
                const lower = statusText.toLowerCase();
                if (!statusText || lower.includes('chờ') || lower.includes('cho')) {
                  statusText = 'Đã xác nhận';
                }
                span.textContent = statusText;
                statusTd.appendChild(span);
                statusTd.classList.add('col-status');
                tr.appendChild(statusTd);

                const actionTd = document.createElement('td');
                actionTd.classList.add('col-action');

                // nút Đánh giá: nếu booking đã có trong evaluations thì hiển thị trạng thái "Đã đánh giá"
                const evalId = String(b.id || b.bookingId || '').replace(/^#+/, '').trim();
                if (evalId && evaluatedIds.has(evalId)) {
                    const doneSpan = document.createElement('span');
                    doneSpan.className = 'btn-primary disabled';
                    doneSpan.textContent = 'Đã đánh giá';
                    doneSpan.setAttribute('aria-disabled', 'true');
                    doneSpan.style.opacity = '0.8';
                    doneSpan.style.pointerEvents = 'none';
                    actionTd.appendChild(doneSpan);
                } else {
                    const cancelBtn = document.createElement('button');
                    cancelBtn.className = 'btn-cancel';
                    cancelBtn.textContent = 'Hủy';
                    cancelBtn.style.cssText = 'background:#e74c3c;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer;';
                    cancelBtn.dataset.id = b.id || '';
                    actionTd.appendChild(cancelBtn);

                    const evalLink = document.createElement('a');
                    const orderIdForParam = (b.id || b.bookingId || '').replace(/^#+/, '');
                    const tourParam = encodeURIComponent((b.tourName || b.tour || '').toString());
                    evalLink.href = `evaluate.html?bookingId=${encodeURIComponent(orderIdForParam)}&tourName=${tourParam}`;
                    evalLink.className = 'btn-primary';
                    evalLink.textContent = 'Đánh giá';
                    actionTd.appendChild(evalLink);
                }

                tr.appendChild(actionTd);
                tbody.appendChild(tr);
            });
        }

        // sự kiện hủy: xóa booking -> render lại
        document.addEventListener('click', function (ev) {
            const btn = ev.target.closest('.btn-cancel');
            if (!btn) return;
            const id = btn.dataset.id;
            if (!id) return;
            if (!confirm('Bạn có chắc muốn hủy đặt tour này?')) return;
            const all = JSON.parse(localStorage.getItem(KEY) || '[]');
            const remaining = all.filter(x => (x.id || '') !== id);
            localStorage.setItem(KEY, JSON.stringify(remaining));
            render();
        });

        // xóa toàn bộ lịch sử
        if (clearBtn) {
            clearBtn.addEventListener('click', function () {
                if (!confirm('Xóa toàn bộ lịch sử đặt tour?')) return;
                localStorage.removeItem(KEY);
                render();
            });
        }

        // init
        document.addEventListener('DOMContentLoaded', render);
        if (document.readyState === 'interactive' || document.readyState === 'complete') render();
    })();

    document.addEventListener('DOMContentLoaded', function() {
        // 1. Lấy phần tử nút bấm và menu
        const navToggle = document.querySelector('.nav-toggle');
        const body = document.querySelector('body');
        const navLinks = document.querySelectorAll('.nav-links a'); // Các link trong menu

        // 2. Kiểm tra xem nút có tồn tại không để tránh lỗi
        if (navToggle) {
            // 3. Thêm sự kiện click
            navToggle.addEventListener('click', function(e) {
                e.stopPropagation(); // Ngăn chặn sự kiện nổi bọt
                body.classList.toggle('nav-open'); // Thêm/Xóa class 'nav-open'
            });
        }

        // 4. (Tùy chọn) Click vào vùng ngoài hoặc link để đóng menu
        document.addEventListener('click', function(e) {
            // Nếu click ra ngoài menu và menu đang mở -> đóng lại
            if (body.classList.contains('nav-open') && 
                !e.target.closest('nav') && 
                !e.target.closest('.nav-toggle')) {
                body.classList.remove('nav-open');
            }
        });
        
        // Đóng menu khi click vào link bên trong (trải nghiệm người dùng tốt hơn)
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                body.classList.remove('nav-open');
            });
        });
    });
    </script>
</body>
</html>